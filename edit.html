<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Granules Entries</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary-color: #3b82f6; --primary-gradient: linear-gradient(180deg, #3b82f6, #2563eb); }
        body { font-family: 'Nunito', sans-serif; background-color: #f4f7f9; color: #1e293b; margin: 0; padding: 20px; font-size: 17px; }
        header { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; }
        header .zeel img { max-height: 60px; border-radius: 8px; }
        .container { max-width: 1200px; margin: 20px auto; padding: 30px 40px; background-color: #fff; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07); }
        .home-btn-container { position: absolute; top: 20px; left: 20px; }
        .btn, .home-btn, .modal-btn { display: inline-flex; align-items: center; gap: 0.75rem; padding: 12px 24px; border-radius: 10px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; text-decoration: none; color: #fff; }
        .home-btn { background: #64748b; }
        .btn-primary { background: var(--primary-gradient); }
        .btn-secondary { background: #64748b; }
        .btn-delete { background-color: #fee2e2; color: #b91c1c; border: none; padding: 8px 12px; font-size: 0.9rem; border-radius: 8px; margin-left: 5px;}
        .btn-edit { background-color: #dbeafe; color: #1d4ed8; border: none; padding: 8px 12px; font-size: 0.9rem; border-radius: 8px; }
        .btn-details { background-color: #e0e7ff; color: #3730a3; border: none; padding: 8px 12px; font-size: 1.1rem; line-height: 1; border-radius: 8px; }
        h2 { text-align: center; margin-bottom: 30px; font-size: 2rem; color: var(--primary-color); }
        .controls { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .filters { display: flex; flex-direction: column; gap: 15px; }
        .actions { display: flex; flex-direction: column; gap: 15px; }
        .filters input { padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; font-family: 'Nunito', sans-serif; }
        .table-wrapper { overflow-x: auto; }
        #dataTable { width: 100%; border-collapse: collapse; text-align: left; }
        #dataTable th, #dataTable td { padding: 16px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        #dataTable thead th { background-color: #f8fafc; font-weight: 700; color: #475569; font-size: 0.9rem; text-transform: uppercase; }
        #dataTable tbody tr:hover { background-color: #f1f5f9; }
        .selected-row { background-color: #dbeafe !important; }
        .dispatch-row { background-color: #fad1d1 !important; color: #000000; }
        footer { text-align: center; margin-top: 40px; color: #9ca3af; }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; margin: auto; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; font-size: 1.5rem; color: var(--primary-color); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #333; }
        .modal-form { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .modal-form label { font-weight: 600; margin-bottom: 5px; display: block; }
        .modal-form input, .modal-form select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        .modal-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-btn.btn-save { background: var(--primary-gradient); }
        .modal-btn.btn-cancel { background: #64748b; }
        .audit-details p { margin: 12px 0; color: #334155; }
        .audit-details strong { color: #1e293b; }
        @media (min-width: 1024px) { .controls { flex-direction: row; justify-content: space-between; align-items: center; } .filters, .actions { flex-direction: row; gap: 15px; } .modal-form { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <header><div class="zeel"><img src="aa.jpg" alt="photo" /></div></header>
    <div class="home-btn-container">
        <a href="stock.html" class="home-btn"><span></span><span>Home</span></a>
    </div>

    <div class="container">
        <h2>Granules Stock Details</h2>
        <div class="controls">
            <div class="filters">
                <input type="date" id="filterFrom" title="Filter from date" />
                <input type="date" id="filterTo" title="Filter to date" />
                <input type="text" id="searchBox" placeholder="Search anything..." />
            </div>
            <div class="actions">
                <button class="btn btn-secondary" onclick="mergeSelected()"><span>âœ¨</span><span>Merge Selected</span></button>
                <button class="btn btn-primary" onclick="downloadSelectedPDF()"><span>ðŸ“¥</span><span>Selected PDF</span></button>
                <button class="btn btn-primary" onclick="downloadDispatchPDF()"><span>ðŸ“¥</span><span>Dispatch PDF</span></button>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="dataTable">
                <thead><tr><th><input type="checkbox" id="selectAll" onclick="selectAllRows(this)"></th><th>Siral No.</th><th>Date</th><th>Bags</th><th>Color</th><th>Weight</th><th>Total Wt.</th><th>Price (Total)</th><th>Actions</th><th>To Parcel</th><th>Details</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal">
        </div>
    <div id="auditModal" class="modal">
        </div>

    <div id="mergeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Merge</h3>
                <span class="close-btn" onclick="closeMergeModal()">&times;</span>
            </div>
            <div id="mergeSummary"></div>
            <div class="modal-form">
                <div>
                    <label for="mergeColor">Select Final Color</label>
                    <select id="mergeColor">
                        <option value="green">green</option>
                        <option value="black-green">black-green</option>
                        <option value="golden">golden</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn btn-cancel" onclick="closeMergeModal()">Cancel</button>
                <button type="button" id="confirmMergeBtn" class="modal-btn btn-save">Confirm Merge</button>
            </div>
        </div>
    </div>
    
    <canvas id="chartCanvas" style="display: none;"></canvas>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // --- (Global variables and onAuthStateChanged listener remain the same) ---
        const tbody = document.querySelector("#dataTable tbody");
        const editModal = document.getElementById("editModal");
        const auditModal = document.getElementById("auditModal");
        const mergeModal = document.getElementById("mergeModal");
        let allData = [];
        let myPieChart;
        
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                db.collection('users').doc(user.uid).collection('granules')
                  .orderBy("siral", "desc")
                  .onSnapshot(querySnapshot => {
                    allData = [];
                    querySnapshot.forEach(doc => {
                        let entry = doc.data();
                        entry.id = doc.id;
                        allData.push(entry);
                    });
                    renderTable(allData);
                }, error => {
                    console.error("Error fetching data: ", error);
                });
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- (renderTable and applyFilters remain the same) ---
        function renderTable(dataToRender = []) { /* ... */ }
        function applyFilters() { /* ... */ }

        // --- UPDATED PDF DOWNLOAD FUNCTIONS ---
        function downloadSelectedPDF() {
            const selectedData = allData.filter(entry => 
                document.querySelector(`.row-check[data-id="${entry.id}"]`)?.checked
            );
            if (selectedData.length === 0) { return alert("No rows selected to download."); }
            generatePDF(selectedData, "Selected Granules");
        }

        function downloadDispatchPDF() {
            const dispatchData = allData.filter(entry => entry.dispatch);
            if (dispatchData.length === 0) { return alert("No dispatch data found."); }
            generatePDF(dispatchData, "Dispatch Granules");
        }
        
        // NEW: Centralized PDF generation function
        function generatePDF(data, title) {
            const reversedData = data.slice().reverse();
            const colorCounts = reversedData.reduce((acc, current) => {
                const color = current.color || "Unknown";
                acc[current.color] = (acc[current.color] || 0) + parseFloat(current.bags);
                return acc;
            }, {});

            const doc = new jsPDF();
            doc.text(`${title} Data`, 14, 16);
            
            // Main data table
            const tableHeaders = [["Siral No.", "Date", "Bags", "Color", "Weight", "Total Wt.", "Price (Total)"]];
            const tableBody = reversedData.map((d, index) => {
                const totalWeight = parseFloat(d.bags) * parseFloat(d.weight);
                const totalPrice = totalWeight * parseFloat(d.price);
                return [d.siral, d.date, d.bags, d.color, d.weight, totalWeight.toFixed(2), `${d.price} (${totalPrice.toFixed(2)})`];
            });
            const grandTotalWeight = data.reduce((sum, d) => sum + (parseFloat(d.bags) * parseFloat(d.weight)), 0);
            const grandTotalPrice = data.reduce((sum, d) => sum + ((parseFloat(d.bags) * parseFloat(d.weight)) * parseFloat(d.price)), 0);
            tableBody.push(["", "", "", "", "Total:", grandTotalWeight.toFixed(2), `â‚¹ ${grandTotalPrice.toFixed(2)}`]);
            doc.autoTable({ head: tableHeaders, body: tableBody, startY: 24 });

            const tableEndY = doc.autoTable.previous.finalY;
            const spaceBelowTable = doc.internal.pageSize.height - tableEndY;

            // Color summary table
            const colorHeaders = [["Color", "Total Bags"]];
            const colorBody = Object.entries(colorCounts).map(([color, count]) => [color, count]);
            
            // Draw chart on hidden canvas
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            if (myPieChart) myPieChart.destroy();
            myPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(colorCounts),
                    datasets: [{ data: Object.values(colorCounts), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1'] }]
                },
                options: { responsive: false, animation: { duration: 0 }, plugins: { legend: { display: false } } }
            });
            
            const chartImage = canvas.toDataURL('image/png', 1.0);
            
            // Position summary and chart below the main table
            const summaryY = tableEndY + 10;
            doc.autoTable({
                head: colorHeaders,
                body: colorBody,
                startY: summaryY,
                margin: { right: 105 } // Leave space on the right for the chart
            });
            doc.addImage(chartImage, 'PNG', 110, summaryY, 80, 80);
            
            doc.save(`${title.replace(' ', '_')}.pdf`);
        }

        // --- NEW MERGE FUNCTIONS ---
        function mergeSelected() {
            const selectedData = allData.filter(entry => 
                document.querySelector(`.row-check[data-id="${entry.id}"]`)?.checked
            );
            
            if (selectedData.length < 2) {
                return alert("Please select at least two entries to merge.");
            }

            const totalBags = selectedData.reduce((sum, d) => sum + parseFloat(d.bags), 0);
            const summaryDiv = document.getElementById('mergeSummary');
            summaryDiv.innerHTML = `<p>You are about to merge <strong>${selectedData.length}</strong> entries into a single new entry with a total of <strong>${totalBags}</strong> bags.</p><p>Please select the final color for the new entry.</p>`;
            
            const confirmBtn = document.getElementById('confirmMergeBtn');
            confirmBtn.onclick = () => performMerge(selectedData); // Pass selectedData to the handler

            mergeModal.style.display = "flex";
        }
        
        function closeMergeModal() {
            mergeModal.style.display = "none";
        }

        async function performMerge(selectedData) {
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            document.getElementById('confirmMergeBtn').disabled = true;
            document.getElementById('confirmMergeBtn').textContent = "Merging...";

            try {
                // 1. Calculate new values
                const totalBags = selectedData.reduce((sum, d) => sum + parseFloat(d.bags), 0);
                const totalWeight = selectedData.reduce((sum, d) => sum + (parseFloat(d.bags) * parseFloat(d.weight)), 0);
                const totalValue = selectedData.reduce((sum, d) => sum + (parseFloat(d.bags) * parseFloat(d.weight) * parseFloat(d.price)), 0);
                
                const newWeight = totalWeight / totalBags;
                const newPrice = totalValue / totalWeight;
                const newColor = document.getElementById('mergeColor').value;
                const newDate = new Date().toISOString().split("T")[0];

                const granulesRef = db.collection('users').doc(user.uid).collection('granules');

                // 2. Get the next Siral Number
                const lastEntrySnapshot = await granulesRef.orderBy("siral", "desc").limit(1).get();
                const nextSiral = lastEntrySnapshot.empty ? 1 : lastEntrySnapshot.docs[0].data().siral + 1;
                
                // 3. Create new entry and delete old ones in a batch
                const batch = db.batch();
                const newEntryRef = granulesRef.doc(); // Create a reference for the new document
                
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                let editorName = user.email;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if(userDoc.exists && userDoc.data().fullName) { editorName = userDoc.data().fullName; }

                batch.set(newEntryRef, {
                    siral: nextSiral,
                    date: newDate,
                    bags: totalBags.toFixed(2),
                    color: newColor,
                    weight: newWeight.toFixed(2),
                    price: newPrice.toFixed(2),
                    dispatch: false,
                    createdBy: editorName,
                    createdAt: timestamp,
                    lastEditedBy: editorName,
                    lastEditedAt: timestamp
                });

                selectedData.forEach(doc => {
                    const docRef = granulesRef.doc(doc.id);
                    batch.delete(docRef);
                });

                await batch.commit();

                showToastMessage("Entries merged successfully!");
            } catch (error) {
                console.error("Error merging entries: ", error);
                showToastMessage("Error merging entries. Please try again.");
            } finally {
                document.getElementById('confirmMergeBtn').disabled = false;
                document.getElementById('confirmMergeBtn').textContent = "Confirm Merge";
                closeMergeModal();
            }
        }
        function openEditModal(docId) {
            const entry = allData.find(e => e.id === docId);
            if (!entry) return;
            document.getElementById('editDocId').value = docId;
            document.getElementById('editSiral').value = entry.siral;
            document.getElementById('editDate').value = entry.date;
            document.getElementById('editBags').value = entry.bags;
            document.getElementById('editColor').value = entry.color;
            document.getElementById('editWeight').value = entry.weight;
            document.getElementById('editPrice').value = entry.price;
            editModal.style.display = "flex";
        }
        function closeEditModal() { editModal.style.display = "none"; }
        function openAuditModal(docId) {
            const entry = allData.find(e => e.id === docId);
            if (!entry) return;
            const formatTimestamp = (timestamp) => {
                if (timestamp && typeof timestamp.toDate === 'function') { return timestamp.toDate().toLocaleString(); }
                return 'N/A';
            };
            document.getElementById('createdBy').textContent = entry.createdBy || 'N/A';
            document.getElementById('createdAt').textContent = formatTimestamp(entry.createdAt);
            document.getElementById('lastEditedBy').textContent = entry.lastEditedBy || 'N/A';
            document.getElementById('lastEditedAt').textContent = formatTimestamp(entry.lastEditedAt);
            auditModal.style.display = "flex";
        }
        function closeAuditModal() { auditModal.style.display = "none"; }
        window.onclick = function(event) {
            if (event.target == editModal) { closeEditModal(); }
            if (event.target == auditModal) { closeAuditModal(); }
        }
        function showToastMessage(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            Object.assign(toast.style, {
                position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                backgroundColor: '#2c3e50', color: 'white', padding: '12px 24px', borderRadius: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: '1000', fontFamily: 'Nunito, sans-serif',
                fontSize: '16px', opacity: '0', transition: 'opacity 0.3s ease-in-out'
            });
            document.body.appendChild(toast);
            setTimeout(() => toast.style.opacity = '1', 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        function highlightRow(checkbox) {
            const row = checkbox.closest("tr");
            if (!row.classList.contains("dispatch-row")) { row.classList.toggle("selected-row", checkbox.checked); } 
            else { checkbox.checked = false; }
        }
        function selectAllRows(masterCheckbox) {
            document.querySelectorAll(".row-check").forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = masterCheckbox.checked;
                    highlightRow(cb);
                }
            });
        }
        function deleteEntry(docId) {
            if (!confirm("Are you sure you want to delete this entry?")) return;
            const user = firebase.auth().currentUser;
            if (user && docId) {
                db.collection('users').doc(user.uid).collection('granules').doc(docId).delete()
                  .then(() => showToastMessage("Entry deleted successfully."))
                  .catch(error => showToastMessage("Error deleting entry."));
            }
        }
        async function toggleDispatchStatus(docId) {
            const user = firebase.auth().currentUser;
            if (!user || !docId) return;
            const docRef = db.collection('users').doc(user.uid).collection('granules').doc(docId);
            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    const newStatus = !doc.data().dispatch;
                    await docRef.update({ dispatch: newStatus });
                    const message = newStatus ? "Item marked as dispatched." : "Item marked as not dispatched.";
                    showToastMessage(message);
                }
            } catch (error) {
                console.error("Error updating dispatch status: ", error);
                showToastMessage("Error updating status.");
            }
        }
        document.getElementById("searchBox").addEventListener("input", applyFilters);
        document.getElementById("filterFrom").addEventListener("change", applyFilters);
        document.getElementById("filterTo").addEventListener("change", applyFilters);
        
        // --- (All other helper functions like saveChanges, openEditModal, etc., remain the same) ---
    </script>
</body>
</html>