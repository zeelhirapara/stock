<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parcel Details</title>
  <link rel="shortcut icon" href="aa.jpg" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="Bbox.css">
</head>
<body>
  <div class="box">
    <div class="zeel"><img src="aa.jpg" alt="photo" /></div>
  </div>
  <div class="st">
  <h2>Saved Parcel Entries</h2>
    </div>
  <div>
    <input type="date" id="filterFrom" />
    <input type="date" id="filterTo" />
    <input type="text" id="searchBox" placeholder="Search..." />
    <button onclick="downloadSelectedPDF()">Download Selected PDF</button>
    <button onclick="downloadDeparturePDF()">Download Departure PDF</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" onclick="selectAllRows(this)"></th>
        <th>Parcel</th>
        <th>Weight</th>
        <th>Date</th>
        <th>Size</th>
        <th>Percentage</th>
        <th>Color</th>
        <th>Actions</th>
        <th>Departure</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let data = JSON.parse(localStorage.getItem("parcelData")) || [];
    const tbody = document.querySelector("#dataTable tbody");

    function renderTable(filtered = data) {
      tbody.innerHTML = "";
      filtered.forEach((entry, index) => {
        const tr = document.createElement("tr");
        tr.className = entry.departure ? "departure-row" : "";
        tr.innerHTML = `
          <td><input type="checkbox" class="row-check" onchange="highlightRow(this)" ${entry.departure ? 'disabled' : ''}></td>
          <td>${entry.parcel}</td>
          <td>${entry.weight}</td>
          <td>${entry.date}</td>
          <td>${entry.size}</td>
          <td>${entry.percentage}</td>
          <td>${entry.color}</td>
        <td><button onclick="deleteEntry(${index})">Delete</button></td>
          <td><input type="checkbox" class="departure-check" onchange="markRowAsDeparture(${index})" ${entry.departure ? 'checked disabled' : ''}></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function highlightRow(checkbox) {
      const row = checkbox.closest("tr");
      const departureCheckbox = row.querySelector(".departure-check");
      if (!departureCheckbox.checked) {
        if (checkbox.checked) {
          row.classList.add("selected-row");
        } else {
          row.classList.remove("selected-row");
        }
      } else {
        checkbox.checked = false;
      }
    }

    function selectAllRows(masterCheckbox) {
      const checkboxes = document.querySelectorAll(".row-check");
      checkboxes.forEach(cb => {
        if (!cb.disabled) {
          cb.checked = masterCheckbox.checked;
          highlightRow(cb);
        }
      });
    }

    function markRowAsDeparture(index) {
      if (!confirm("Mark this entry as departure?")) return;
      data[index].departure = true;
      localStorage.setItem("parcelData", JSON.stringify(data));
      const row = tbody.children[index];
      if (row) {
        row.classList.remove("selected-row");
        row.classList.add("departure-row");
        const leftCheckbox = row.querySelector(".row-check");
        if (leftCheckbox) {
          leftCheckbox.checked = false;
          leftCheckbox.disabled = true;
        }
        const rightCheckbox = row.querySelector(".departure-check");
        if (rightCheckbox) {
          rightCheckbox.checked = true;
          rightCheckbox.disabled = true;
        }
      }
    }

    function downloadSelectedPDF() {
      const selectedRows = Array.from(document.querySelectorAll(".selected-row"));
      if (selectedRows.length === 0) {
        alert("No selected rows found.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = [["Parcel", "Weight", "Date", "Size", "Percentage", "Color"]];
      const body = selectedRows.map(row => {
        const cells = row.querySelectorAll("td");
        return [
          cells[1].innerText,
          cells[2].innerText,
          cells[3].innerText,
          cells[4].innerText,
          cells[5].innerText,
          cells[6].innerText
        ];
      });
      doc.text("Selected Parcel Data", 14, 10);
      doc.autoTable({ head: headers, body, startY: 20 });
      doc.save("selected_parcels.pdf");
    }

    function downloadDeparturePDF() {
      const departureData = data.filter(entry => entry.departure);
      if (departureData.length === 0) {
        alert("No departure data found.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = [["Parcel", "Weight", "Date", "Size", "Percentage", "Color"]];
      const body = departureData.map(d => [d.parcel, d.weight, d.date, d.size, d.percentage, d.color]);
      doc.text("Departure Data", 14, 10);
      doc.autoTable({ head: headers, body, startY: 20 });
      doc.save("departure_data.pdf");
    }

    function applyFilters() {
  const search = document.getElementById("searchBox").value.toLowerCase();
  const from = new Date(document.getElementById("filterFrom").value);
  const to = new Date(document.getElementById("filterTo").value);

  return data.filter(entry => {
    const entryDate = new Date(entry.date);
    const matchesSearch = Object.values(entry).some(val =>
      typeof val === 'string' && val.toLowerCase().includes(search)
    );
    const matchesDate = (!isNaN(from) ? entryDate >= from : true) &&
                        (!isNaN(to) ? entryDate <= to : true);
    return matchesSearch && matchesDate;
  });
}


    document.getElementById("searchBox").addEventListener("input", () => renderTable(applyFilters()));
    document.getElementById("filterFrom").addEventListener("change", () => renderTable(applyFilters()));
    document.getElementById("filterTo").addEventListener("change", () => renderTable(applyFilters()));
    window.onload = () => renderTable();


    function deleteEntry(index) {
  if (!confirm("Are you sure you want to delete this entry?")) return;

  data.splice(index, 1); // remove the entry from the data array
  localStorage.setItem("parcelData", JSON.stringify(data)); // save updated data
  renderTable(); // re-render the table
  renderGroupedTables(); // re-render the grouped percentage tables
}




  </script>
</body>
</html>