<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>details</title>
    <link rel="shortcut icon" href="aa.jpg" type="image/x-icon">
        <link rel="stylesheet" href="Bbox.css" />
</head>
<body>
    <div class="box">
    <div class="zeel"><img src="aa.jpg" alt="photo" /></div>
    </div>
   <h2>Saved Parcel Entries</h2>

  <div style="display: flex; justify-content: flex-end; gap: 10px; margin: 10px;">
    <input type="date" id="filterFrom" />
    <input type="date" id="filterTo" />
    <input type="text" id="searchBox" placeholder="Search..." />
  </div>

    <h3 id="entryCount">Total Entries: 0</h3>
<table border="1" cellpadding="10" cellspacing="0" style="width: 100%; text-align: center;" id="dataTable">
  <thead>
    <tr>
      <th>Select</th>
      <th>Parcel</th>
      <th>Weight</th>
      <th>Date</th>
      <th>Size</th>
      <th>Percentage</th>
      <th>Color</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody> <!-- ✅ ADD THIS -->
</table>

<div style="margin: 20px; font-size: 18px;">
  <strong>Selected:</strong> <span id="selectedCount">0</span> items,
  <strong>Total:</strong> <span id="totalCount">0</span> items<br>
  <strong>Total Weight (All):</strong> <span id="allWeight">0</span> kg<br>
  <strong>Selected Weight:</strong> <span id="selectedWeight">0</span> kg
</div>



  
<div style="text-align: right; margin: 20px;">
  <button onclick="downloadSelected()" style="padding: 10px 20px; font-size: 18px;">Download Selected</button>
</div>



   <div id="sidebar" class="sidebar">
  <button class="closebtn" onclick="toggleSidebar()">&times;</button>
  <a href="index.html">Home</a>
  <a href="Abox.html">Add New Entry</a>

  <a href="Cbox.html">Download Excel File</a>
</div>
<button class="openbtn" onclick="toggleSidebar()">&#9776; Menu</button>

<button id="downloadSelectedBtn" onclick="downloadSelected()">Download Selected</button>




  <script>
  let data = JSON.parse(localStorage.getItem("parcelData")) || [];
  const tbody = document.querySelector("#dataTable tbody");

  function renderTable(filtered = data) {
    document.getElementById("entryCount").textContent = `Total Entries: ${filtered.length}`;
    tbody.innerHTML = "";

    if (filtered.length === 0) {
      tbody.innerHTML = "<tr><td colspan='8'>No data found</td></tr>";
      return;
    }

    filtered.forEach((entry, index) => {
      const tr = document.createElement("tr");
      tr.setAttribute("data-index", index);
      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" onchange="toggleRowSelection(this)"></td>
        <td>${entry.parcel}</td>
        <td>${entry.weight}</td>
        <td>${entry.date}</td>
        <td>${entry.size}</td>
        <td>${entry.percentage}</td>
        <td>${entry.color}</td>
        <td>
          <button onclick="editEntry(${index})">✏️ Edit</button>
          <button onclick="deleteEntry(${index})">❌ Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    updateCounts(filtered);
  }

  function updateCounts(dataArray) {
  const checkboxes = document.querySelectorAll(".row-check:checked");

  const selectedWeight = Array.from(checkboxes).reduce((sum, cb) => {
    const row = cb.closest("tr");
    const weight = parseFloat(row.children[2].textContent.trim()) || 0;
    return sum + weight;
  }, 0);

  const totalWeight = dataArray.reduce((sum, entry) => {
    return sum + (parseFloat(entry.weight) || 0);
  }, 0);

  document.getElementById("selectedCount").textContent = checkboxes.length;
  document.getElementById("totalCount").textContent = dataArray.length;
  document.getElementById("allWeight").textContent = totalWeight.toFixed(2);
  document.getElementById("selectedWeight").textContent = selectedWeight.toFixed(2);
}
  function deleteEntry(index) {
    if (confirm("Are you sure you want to delete this entry?")) {
      data.splice(index, 1);
      localStorage.setItem("parcelData", JSON.stringify(data));
      renderTable(applyFilters());
    }
  }

  function editEntry(index) {
    const entry = data[index];
    const newParcel = prompt("Edit Parcel Number:", entry.parcel);
    const newWeight = prompt("Edit Weight:", entry.weight);
    const newDate = prompt("Edit Date (YYYY-MM-DD):", entry.date);
    const newSize = prompt("Edit Size:", entry.size);
    const newPerc = prompt("Edit Percentage:", entry.percentage);
    const newColor = prompt("Edit Color:", entry.color);

    if (newParcel && newWeight && newDate && newSize && newPerc && newColor) {
      data[index] = {
        parcel: newParcel,
        weight: newWeight,
        date: newDate,
        size: newSize,
        percentage: newPerc,
        color: newColor
      };
      localStorage.setItem("parcelData", JSON.stringify(data));
      renderTable(applyFilters());
    }
  }

  function applyFilters() {
    const search = document.getElementById("searchBox").value.toLowerCase();
    const from = new Date(document.getElementById("filterFrom").value);
    const to = new Date(document.getElementById("filterTo").value);

    return data.filter(entry => {
      const entryDate = new Date(entry.date);
      const matchesSearch = Object.values(entry).some(val => val.toLowerCase().includes(search));
      const matchesDate =
        (!isNaN(from) ? entryDate >= from : true) &&
        (!isNaN(to) ? entryDate <= to : true);
      return matchesSearch && matchesDate;
    });
  }

  function toggleRowSelection(checkbox) {
    const row = checkbox.closest("tr");
    row.classList.toggle("selected-row", checkbox.checked);

    const anyChecked = document.querySelectorAll(".row-check:checked").length > 0;
    document.getElementById("downloadSelectedBtn").style.display = anyChecked ? "block" : "none";

    updateCounts(applyFilters());
  }

  function downloadSelected() {
  const selectedRows = document.querySelectorAll(".row-check:checked");
  if (selectedRows.length === 0) {
    alert("No rows selected!");
    return;
  }

  let csv = "Parcel,Weight,Date,Size,Percentage,Color\n";
  let totalWeight = 0;

  selectedRows.forEach(cb => {
    const cells = cb.closest("tr").querySelectorAll("td");
    const rowData = Array.from(cells).slice(1, 7).map(cell => cell.textContent.trim());

    const weight = parseFloat(rowData[1]) || 0;
    totalWeight += weight;

    csv += rowData.join(",") + "\n";
  });

  csv += `,,,,Total Weight,${totalWeight.toFixed(2)}\n`;

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "selected_parcel_data.csv";
  a.click();
  URL.revokeObjectURL(url);
}


  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    sidebar.style.width = sidebar.style.width === "250px" ? "0" : "250px";
  }

  document.getElementById("searchBox").addEventListener("input", () => renderTable(applyFilters()));
  document.getElementById("filterFrom").addEventListener("change", () => renderTable(applyFilters()));
  document.getElementById("filterTo").addEventListener("change", () => renderTable(applyFilters()));

  window.onload = () => {
    renderTable();
  };
</script>


</body>
</html>