<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Entry For Granules</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
         /* This uses the same big, bold design from before */
        :root { --primary-color: #3b82f6; --primary-gradient: linear-gradient(180deg, #3b82f6, #2563eb); /* etc. */ }
        body { font-family: 'Nunito', sans-serif; background-color: #f4f7f9; color: #1e293b; margin: 0; padding: 20px; font-size: 17px; }
        header { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; }
        header .zeel img { max-height: 60px; border-radius: 8px; }
        .container { max-width: 900px; margin: 20px auto; padding: 30px 40px; background-color: #fff; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07); }
        .home-btn-container { position: absolute; top: 20px; left: 20px; }
        .btn, .home-btn { display: inline-flex; align-items: center; gap: 0.75rem; padding: 12px 24px; border-radius: 10px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; text-decoration: none; color: #fff; }
        .home-btn { background: #64748b; }
        .btn-primary { background: var(--primary-gradient); }
        h2 { text-align: center; margin-bottom: 30px; font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { margin-bottom: 10px; font-weight: 600; }
        .input-group input, .input-group select { padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1.05rem; font-family: 'Nunito', sans-serif; }
        .save-button-container { text-align: center; margin-top: 40px; }
        footer { text-align: center; margin-top: 40px; color: #9ca3af; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <header>
        <div class="zeel"><img src="aa.jpg" alt="photo" /></div>
    </header>
    <div class="home-btn-container">
        <a href="stock.html" class="home-btn">
            <span></span>
            <span>Home</span>
        </a>
    </div>

    <div class="container">
        <h2>New Granule Entry</h2>
        <div class="form-grid">
            <div class="input-group">
                <label for="Siral-number">Siral Number</label>
                <input type="number" id="Siral-number" placeholder="Loading...">
            </div>
            <div class="input-group">
                <label for="date">Date</label>
                <input type="date" id="date">
            </div>
            <div class="input-group">
                <label for="bags">Number of Bag's</label>
                <input type="number" id="bags" placeholder="e.g., 50">
            </div>
            <div class="input-group">
                <label for="color">Color</label>
                <select id="color">
                    <option value="" disabled>Select a color</option>
                    <option value="green">green</option>
                    <option value="black-green">black-green</option>
                    <option value="golden">golden</option>
                </select>
            </div>
            <div class="input-group">
                <label for="weight">Weight (per bag)</label>
                <input type="number" id="weight">
            </div>
            <div class="input-group">
                <label for="price">Price (per bag)</label>
                <input type="number" id="price" placeholder="e.g., 150.00">
            </div>
        </div>
        <div class="save-button-container">
            <button class="btn btn-primary" onclick="saveData()">
                <span>âž•</span>
                <span>Save Entry</span>
            </button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        window.onload = () => {
            const siralInput = document.getElementById('Siral-number');
            const dateInput = document.getElementById('date');
            const colorInput = document.getElementById('color');
            const weightInput = document.getElementById('weight');

            dateInput.value = new Date().toISOString().split("T")[0];
            weightInput.value = "25.00";
            const lastColor = localStorage.getItem('lastGranuleColor');
            if (lastColor) { colorInput.value = lastColor; } else { colorInput.value = ""; }

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    db.collection('users').doc(user.uid).collection('granules').get()
                        .then(querySnapshot => {
                            if (querySnapshot.empty) {
                                siralInput.value = 1;
                            } else {
                                let maxSiral = 0;
                                querySnapshot.forEach(doc => {
                                    const siral = parseInt(doc.data().siral);
                                    if (siral > maxSiral) { maxSiral = siral; }
                                });
                                siralInput.value = maxSiral + 1;
                            }
                        });
                } else {
                    window.location.href = 'login.html';
                }
            });
        };

        async function saveData() {
            const user = firebase.auth().currentUser;
            if (!user) {
                alert("You must be logged in to save data.");
                return window.location.href = 'login.html';
            }

            const siral = document.getElementById('Siral-number').value;
            const bags = document.getElementById('bags').value;
            const date = document.getElementById('date').value;
            const color = document.getElementById('color').value;
            const weight = document.getElementById('weight').value;
            const price = document.getElementById('price').value;

            if (!siral || !bags || !date || !color || !weight || !price) {
                return alert("Please fill all fields.");
            }

            localStorage.setItem('lastGranuleColor', color);
            
            const querySnapshot = await db.collection('users').doc(user.uid).collection('granules')
                .where('siral', '==', siral)
                .get();

            if (!querySnapshot.empty) {
                // --- If an entry is found, UPDATE it ---
                const existingDoc = querySnapshot.docs[0];
                const existingData = existingDoc.data();

                if (existingData.departure) {
                    return alert(`Siral Number ${siral} has already been marked as departed and cannot be modified.`);
                }

                const newBags = (parseFloat(existingData.bags) + parseFloat(bags)).toFixed(2);
                const newWeight = (parseFloat(existingData.weight) + parseFloat(weight)).toFixed(2);
                
                await db.collection('users').doc(user.uid).collection('granules').doc(existingDoc.id).update({
                    bags: newBags,
                    weight: newWeight,
                    date: date // Update the date to the latest entry
                    // NOTICE: We are NOT updating the price OR the color.
                });

                alert(`Siral Number ${siral} has been updated successfully.`);

            } else {
                // --- If it's a new entry, CREATE it ---
                await db.collection('users').doc(user.uid).collection('granules').add({
                    siral: siral,
                    bags: bags,
                    date: date,
                    color: color,
                    weight: weight,
                    price: price,
                    departure: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                //alert("New granule entry saved!");
            }
            window.location.reload();
        }
    </script>
    <footer>zeel Industries</footer>
</body>
</html>