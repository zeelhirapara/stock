<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Download Excel</title>
  <link rel="shortcut icon" href="aa.jpg" type="image/x-icon" />
  <link rel="stylesheet" href="Cbox.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


</head>
<body>
  <div class="box">
    <div class="zeel"><img src="aa.jpg" alt="photo" /></div>
  </div>

  <div class="all-data">
    <h2>Select Date Range to Download Excel</h2>

    <div>
      <label>From: <input type="date" id="fromDate" /></label>
      <label>To: <input type="date" id="toDate" /></label>
    </div>

    <div class="range-buttons">
      <button onclick="setDateRange('today')">Today</button>
      <button onclick="setDateRange('last7')">Last 7 Days</button>
      <button onclick="setDateRange('lastMonth')">Last Month</button>
      <button onclick="setDateRange('thisYear')">This Year</button>
      <button onclick="setDateRange('all')">All Time</button>
    </div>

    <div class="download-buttons">
      <button onclick="downloadExcel()" class="ab">Download Excel (CSV)</button>
  <button onclick="downloadGroupedExcel()" class="ab">Download Grouped Excel</button>
  <button onclick="downloadGroupedExcelWithSummary()" class="ab">Download Grouped Excel with Summary</button>
</div>

    </div>
  </div>

  <script>
    function downloadExcel() {
      const data = JSON.parse(localStorage.getItem("parcelData")) || [];
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;

      if (!fromDate || !toDate) {
        alert("Please select a date range.");
        return;
      }

      const from = new Date(fromDate);
      const to = new Date(toDate);

      const filteredData = data.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate >= from && entryDate <= to;
      });

      if (filteredData.length === 0) {
        alert("No data in this date range.");
        return;
      }

      let csv = "Parcel Number,Weight,Date,Size,Percentage,Color\n";
      filteredData.forEach(entry => {
        csv += `${entry.parcel},${entry.weight},${entry.date},${entry.size},${entry.percentage},${entry.color}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `parcel_data_${fromDate}_to_${toDate}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function setDateRange(range) {
      const fromInput = document.getElementById("fromDate");
      const toInput = document.getElementById("toDate");

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const todayStr = `${yyyy}-${mm}-${dd}`;

      let from, to;

      switch (range) {
        case "today":
          from = to = todayStr;
          break;
        case "last7":
          from = new Date(today);
          from.setDate(today.getDate() - 6);
          from = from.toISOString().split("T")[0];
          to = todayStr;
          break;
        case "lastMonth":
          const firstDayLastMonth = new Date(yyyy, today.getMonth() - 1, 1);
          const lastDayLastMonth = new Date(yyyy, today.getMonth(), 0);
          from = firstDayLastMonth.toISOString().split("T")[0];
          to = lastDayLastMonth.toISOString().split("T")[0];
          break;
        case "thisYear":
          from = `${yyyy}-01-01`;
          to = todayStr;
          break;
        case "all":
          from = "2000-01-01";
          to = todayStr;
          break;
        default:
          return;
      }

      fromInput.value = from;
      toInput.value = to;
    }

    function downloadGroupedExcelWithSummary() {
  const data = JSON.parse(localStorage.getItem("parcelData")) || [];
  if (data.length === 0) {
    alert("No parcel data found.");
    return;
  }

  const wb = XLSX.utils.book_new();
  const summary = [["Percentage", "Total Weight"]];

  function createSheet(percentage) {
const filtered = data.filter(d => String(d.percentage) === String(percentage));
    const rows = [
      ["Parcel", "Weight", "Date", "Size", "Percentage", "Color"],
      ...filtered.map(d => [d.parcel, d.weight, d.date, d.size, d.percentage, d.color])
    ];

    const totalWeight = filtered.reduce((sum, d) => sum + parseFloat(d.weight || 0), 0);
    rows.push(["", `Total: ${totalWeight}`, "", "", "", ""]);

    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, `Percentage ${percentage}`);
    summary.push([percentage, totalWeight]);
  }

  createSheet("50%");
  createSheet("75%");
  createSheet("90%");

  const summarySheet = XLSX.utils.aoa_to_sheet(summary);
  XLSX.utils.book_append_sheet(wb, summarySheet, "Summary");

  XLSX.writeFile(wb, "Grouped_Parcel_Data_With_Summary.xlsx");
}

function downloadGroupedExcel() {
  const data = JSON.parse(localStorage.getItem("parcelData")) || [];

  if (data.length === 0) {
    alert("❌ No parcel data available.");
    return;
  }

  const wb = XLSX.utils.book_new();

  function createSheet(percentage) {
    const filtered = data.filter(d => String(d.percentage) === String(percentage));
    const rows = [
      ["Parcel", "Weight", "Date", "Size", "Percentage", "Color"],
      ...filtered.map(d => [
        d.parcel || "", 
        d.weight || "", 
        d.date || "", 
        d.size || "", 
        d.percentage || "", 
        d.color || ""
      ])
    ];
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, `Percentage ${percentage}`);
  }

  createSheet("50%");
  createSheet("75%");
  createSheet("90%");

  XLSX.writeFile(wb, "Grouped_Parcel_Data.xlsx");
}
  </script>
</body>
</html>
