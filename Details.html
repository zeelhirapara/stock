<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parcel Details</title>
    <link rel="shortcut icon" href="aa.jpg" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #3b82f6; --primary-gradient: linear-gradient(180deg, #3b82f6, #2563eb); }
        body { font-family: 'Nunito', sans-serif; background-color: #f4f7f9; color: #1e293b; margin: 0; padding: 20px; font-size: 17px; }
        header { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; }
        header .zeel img { max-height: 60px; border-radius: 8px; }
        .container { max-width: 1200px; margin: 20px auto; padding: 30px 40px; background-color: #fff; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07); }
        .home-btn-container { position: absolute; top: 20px; left: 20px; }
        .btn, .home-btn, .modal-btn { display: inline-flex; align-items: center; gap: 0.75rem; padding: 12px 24px; border-radius: 10px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; text-decoration: none; color: #fff; }
        .home-btn { background: #64748b; }
        .btn-primary { background: var(--primary-gradient); }
        .btn-secondary { background: #64748b; }
        .btn-delete { background-color: #fee2e2; color: #b91c1c; border: none; padding: 8px 12px; font-size: 0.9rem; border-radius: 8px; margin-left: 5px; }
        .btn-edit { background-color: #dbeafe; color: #1d4ed8; border: none; padding: 8px 12px; font-size: 0.9rem; border-radius: 8px; }
        .btn-details { background-color: #e0e7ff; color: #3730a3; border: none; padding: 8px 12px; font-size: 1.1rem; line-height: 1; border-radius: 8px; }
        h2 { text-align: center; margin-bottom: 30px; font-size: 2rem; color: var(--primary-color); }
        .controls { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .filters, .actions { display: flex; flex-direction: column; gap: 15px; }
        .filters input { padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; }
        .table-wrapper { overflow-x: auto; }
        #dataTable { width: 100%; border-collapse: collapse; text-align: left; }
        #dataTable th, #dataTable td { padding: 16px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        #dataTable thead th { background-color: #f8fafc; font-weight: 700; color: #475569; font-size: 0.9rem; text-transform: uppercase; }
        #dataTable tbody tr:hover { background-color: #f1f5f9; }
        .selected-row { background-color: #dbeafe !important; }
        .departure-row { background-color: #fad1d1 !important; color: #000000; }
        footer { text-align: center; margin-top: 40px; color: #9ca3af; }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; margin: auto; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 600px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; font-size: 1.5rem; color: var(--primary-color); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #333; }
        .modal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .modal-form label { font-weight: 600; margin-bottom: 5px; display: block; }
        .modal-form input, .modal-form select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        .modal-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-btn.btn-save { background: var(--primary-gradient); }
        .modal-btn.btn-cancel { background: #64748b; }
        .audit-details p { margin: 12px 0; color: #334155; }
        .audit-details strong { color: #1e293b; }
        @media (min-width: 1024px) { .controls { flex-direction: row; justify-content: space-between; align-items: center; } .filters, .actions { flex-direction: row; gap: 15px; } }
    </style>
</head>
<body>
    <header><div class="zeel"><img src="aa.jpg" alt="photo" /></div></header>
    <div class="home-btn-container">
        <a href="stock.html" class="home-btn"><span></span><span>Home</span></a>
    </div>

    <div class="container">
        <h2>Parcel Stock Details</h2>
        <div class="controls">
            <div class="filters">
                <input type="date" id="filterFrom" title="Filter from date" />
                <input type="date" id="filterTo" title="Filter to date" />
                <input type="text" id="searchBox" placeholder="Search anything..." />
            </div>
            <div class="actions">
                
                <button class="btn btn-primary" onclick="downloadSelectedPDF()"><span>üì•</span><span>Selected PDF</span></button>
                <button class="btn btn-primary" onclick="downloadDeparturePDF()"><span>üì•</span><span>Departure PDF</span></button>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="dataTable">
                <thead><tr><th><input type="checkbox" id="selectAll" onclick="selectAllRows(this)"></th><th>Bell</th><th>Parcel</th><th>Weight</th><th>Date</th><th>Size</th><th>Percentage</th><th>Color</th><th>Actions</th><th>Departure</th><th>Details</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Parcel Entry</h3><span class="close-btn" onclick="closeEditModal()">&times;</span></div>
            <form id="editForm" class="modal-form" onsubmit="saveChanges(event)">
                <input type="hidden" id="editDocId">
                <div><label for="editBell">Bell No.</label><input type="number" id="editBell" required></div>
                <div><label for="editParcel">Parcel No.</label><input type="number" id="editParcel" required></div>
                <div><label for="editWeight">Weight</label><input type="number" step="0.01" id="editWeight" required></div>
                <div><label for="editDate">Date</label><input type="date" id="editDate" required></div>
                <div><label for="editSize">Size</label><select id="editSize"><option value="1.5 x 50 m">1.5 x 50 m</option><option value="2 x 50 m">2 x 50 m</option><option value="2.5 x 50 m">2.5 x 50 m</option><option value="3 x 50 m">3 x 50 m</option><option value="6 x 50 m">6 x 50 m</option></select></div>
                <div><label for="editPercentage">Percentage (%)</label><select id="editPercentage"><option value="50%">50%</option><option value="75%">75%</option><option value="90%">90%</option></select></div>
                <div style="grid-column: 1 / -1;"><label for="editColor">Color</label><select id="editColor"><option value="green">green</option><option value="black-green">black-green</option><option value="golden">golden</option></select></div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="modal-btn btn-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="auditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Audit Details</h3><span class="close-btn" onclick="closeAuditModal()">&times;</span></div>
            <div class="audit-details">
                <p><strong>Created By:</strong> <span id="createdBy"></span></p>
                <p><strong>Created At:</strong> <span id="createdAt"></span></p><hr>
                <p><strong>Last Edited By:</strong> <span id="lastEditedBy"></span></p>
                <p><strong>Last Edited At:</strong> <span id="lastEditedAt"></span></p>
            </div>
        </div>
    </div>

    <div id="mergeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Confirm Merge</h3><span class="close-btn" onclick="closeMergeModal()">&times;</span></div>
            <div id="mergeSummary"></div>
            <div class="modal-form" style="grid-template-columns: 1fr;">
                <div><label for="mergeColor">Select Final Color</label><select id="mergeColor"></select></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn btn-cancel" onclick="closeMergeModal()">Cancel</button>
                <button type="button" id="confirmMergeBtn" class="modal-btn btn-save">Confirm Merge</button>
            </div>
        </div>
    </div>
    
    <canvas id="chartCanvas" style="display: none; width: 400px; height: 400px;"></canvas>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // --- THESE VARIABLES WERE MISSING ---
        const tbody = document.querySelector("#dataTable tbody");
        const editModal = document.getElementById("editModal");
        const auditModal = document.getElementById("auditModal");
        const mergeModal = document.getElementById("mergeModal");
        let allData = [];
        let myPieChart;
        
        // --- THIS ENTIRE onAuthStateChanged FUNCTION HAS BEEN UPGRADED ---
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) { throw new Error("User profile not found."); }
                    const groupId = userDoc.data().groupId;

                    db.collection('groups').doc(groupId).collection('parcels')
                      .orderBy("bell", "desc").orderBy("parcel", "desc")
                      .onSnapshot(querySnapshot => {
                        allData = [];
                        querySnapshot.forEach(doc => {
                            let entry = doc.data();
                            entry.id = doc.id;
                            allData.push(entry);
                        });
                        applyFilters();
                    }, error => {
                        console.error("Error fetching parcel data:", error);
                        tbody.innerHTML = `<tr><td colspan="11">Error loading data. Please check Firestore indexes.</td></tr>`;
                    });
                } catch (error) {
                    console.error("Error setting up data listener:", error);
                    tbody.innerHTML = `<tr><td colspan="11">${error.message}</td></tr>`;
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- ALL FUNCTIONS BELOW HAVE BEEN ADDED OR UPGRADED ---
        function renderTable(dataToRender = []) {
            tbody.innerHTML = "";
            if (dataToRender.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">No parcel data found.</td></tr>`;
                return;
            }
            dataToRender.forEach(entry => {
                const tr = document.createElement("tr");
                tr.className = entry.departure ? "departure-row" : "";
                tr.innerHTML = `
                  <td><input type="checkbox" class="row-check" data-id="${entry.id}" onchange="highlightRow(this)" ${entry.departure ? 'disabled' : ''}></td>
                  <td>${entry.bell}</td><td>${entry.parcel}</td><td>${entry.weight}</td>
                  <td>${entry.date}</td><td>${entry.size}</td><td>${entry.percentage}</td>
                  <td>${entry.color}</td>
                  <td>
                      <button class="btn-edit" onclick="openEditModal('${entry.id}')">Edit</button>
                      <button class="btn-delete" onclick="deleteEntry('${entry.id}')">Delete</button>
                  </td>
                  <td><input type="checkbox" class="departure-check" onchange="toggleDepartureStatus('${entry.id}')" ${entry.departure ? 'checked' : ''}></td>
                  <td><button class="btn-details" onclick="openAuditModal('${entry.id}')">üëÅÔ∏è</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function applyFilters() {
            const search = document.getElementById("searchBox").value.toLowerCase();
            const fromDateValue = document.getElementById("filterFrom").value;
            const toDateValue = document.getElementById("filterTo").value;
            const filtered = allData.filter(entry => {
                const matchesDate = (!fromDateValue || entry.date >= fromDateValue) && (!toDateValue || entry.date <= toDateValue);
                if (!matchesDate) return false;
                const searchString = [entry.bell, entry.parcel, entry.weight, entry.date, entry.size, entry.percentage, entry.color].join(' ').toLowerCase();
                const matchesSearch = searchString.includes(search);
                return matchesSearch;
            });
            renderTable(filtered);
        }

        function downloadSelectedPDF() {
            const selectedData = allData.filter(entry => document.querySelector(`.row-check[data-id="${entry.id}"]`)?.checked);
            if (selectedData.length === 0) { return alert("No rows selected to download."); }
            generatePDF(selectedData, "Selected Parcels");
        }

        function downloadDeparturePDF() {
            const departureData = allData.filter(entry => entry.departure);
            if (departureData.length === 0) { return alert("No departure data found."); }
            generatePDF(departureData, "Departure Parcels");
        }
        
        function generatePDF(data, title) {
            try {
                if (!window.jspdf || !window.jspdf.jsPDF) { return alert("Error: PDF library not loaded."); }
                const { jsPDF } = window.jspdf;
                const reversedData = data.slice().reverse();
                
                const percentageCounts = reversedData.reduce((acc, current) => {
                    const percentage = current.percentage || "Unknown";
                    acc[percentage] = (acc[percentage] || 0) + 1;
                    return acc;
                }, {});

                const doc = new jsPDF();
                doc.text(`${title} Data`, 14, 16);
                
                const tableHeaders = [["Sr. No.", "Bell", "Parcel", "Weight", "Date", "Size", "%", "Color"]];
                const tableBody = reversedData.map((d, index) => [
                    index + 1, d.bell, d.parcel, d.weight, d.date, d.size, d.percentage, d.color
                ]);
                const grandTotalWeight = data.reduce((sum, d) => sum + parseFloat(d.weight || 0), 0);
                tableBody.push(["", "", "Total:", grandTotalWeight.toFixed(2), "", "", "", ""]);
                
                doc.autoTable({
                    head: tableHeaders, body: tableBody, startY: 24,
                    headStyles: { fillColor: [34, 139, 34] }
                });

                const tableEndY = doc.autoTable.previous.finalY;
                const summaryHeaders = [["Percentage", "Parcel Count"]];
                const summaryBody = Object.entries(percentageCounts).map(([p, count]) => [p, count]);
                
                const canvas = document.getElementById('chartCanvas');
                const ctx = canvas.getContext('2d');
                if (myPieChart) myPieChart.destroy();
                myPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(percentageCounts),
                        datasets: [{ data: Object.values(percentageCounts), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1'] }]
                    },
                    options: { responsive: false, animation: { duration: 0 }, plugins: { legend: { display: true, position: 'right' } } }
                });

                const chartImage = canvas.toDataURL('image/png', 1.0);
                const summaryY = tableEndY + 10;
                doc.text("Percentage Summary", 14, summaryY + 5);
                doc.autoTable({
                    head: summaryHeaders, body: summaryBody, startY: summaryY + 8,
                    margin: { right: 115 }, headStyles: { fillColor: [34, 139, 34] }
                });
                doc.addImage(chartImage, 'PNG', 100, summaryY, 100, 100);
                
                doc.save(`${title.replace(/ /g, '_')}.pdf`);
            } catch (error) {
                console.error("PDF Generation Error:", error);
                alert("Could not generate PDF. An error occurred: " + error.message);
            }
        }

        function mergeSelected() {
            const selectedData = allData.filter(entry => document.querySelector(`.row-check[data-id="${entry.id}"]`)?.checked);
            if (selectedData.length < 2) { return alert("Please select at least two parcels to merge."); }
            const totalWeight = selectedData.reduce((sum, d) => sum + parseFloat(d.weight || 0), 0);
            
            const summaryDiv = document.getElementById('mergeSummary');
            summaryDiv.innerHTML = `<p>You are merging <strong>${selectedData.length}</strong> parcels into one new parcel with a total weight of <strong>${totalWeight.toFixed(2)}</strong>.</p><p>Please select the final color.</p>`;
            
            const colorSelect = document.getElementById('mergeColor');
            const uniqueColors = [...new Set(allData.map(item => item.color).filter(Boolean))];
            colorSelect.innerHTML = uniqueColors.map(color => `<option value="${color}">${color}</option>`).join('');
            
            const confirmBtn = document.getElementById('confirmMergeBtn');
            confirmBtn.onclick = () => performMerge(selectedData);
            mergeModal.style.display = "flex";
        }
        
        function closeMergeModal() { mergeModal.style.display = "none"; }

        async function performMerge(selectedData) {
            const user = firebase.auth().currentUser;
            if (!user) return;
            const confirmBtn = document.getElementById('confirmMergeBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Merging...";
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const groupId = userDoc.data().groupId;
                const editorName = userDoc.data().fullName || user.email;

                const newWeight = selectedData.reduce((sum, d) => sum + parseFloat(d.weight || 0), 0);
                const newColor = document.getElementById('mergeColor').value;
                const newDate = new Date().toISOString().split("T")[0];
                const parcelsRef = db.collection('groups').doc(groupId).collection('parcels');
                const lastEntrySnapshot = await parcelsRef.orderBy("createdAt", "desc").limit(1).get();
                let nextBell = 1, nextParcel = 1;
                if (!lastEntrySnapshot.empty) {
                    const latestParcel = lastEntrySnapshot.docs[0].data();
                    const lastBell = parseInt(latestParcel.bell);
                    const bellSnapshot = await parcelsRef.where("bell", "==", latestParcel.bell).get();
                    if (bellSnapshot.size >= 10) {
                        nextBell = lastBell + 1;
                    } else {
                        nextBell = lastBell;
                        nextParcel = bellSnapshot.size + 1;
                    }
                }
                const batch = db.batch();
                const newEntryRef = parcelsRef.doc();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                batch.set(newEntryRef, {
                    bell: nextBell, parcel: nextParcel, weight: newWeight.toFixed(2), date: newDate,
                    color: newColor, size: selectedData[0].size, percentage: selectedData[0].percentage,
                    departure: false, createdBy: editorName, createdAt: timestamp,
                    lastEditedBy: editorName, lastEditedAt: timestamp
                });
                selectedData.forEach(doc => { batch.delete(parcelsRef.doc(doc.id)); });
                await batch.commit();
                showToastMessage("Parcels merged successfully!");
            } catch (error) {
                console.error("Error merging entries: ", error);
                showToastMessage("Error merging entries. Please try again.");
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Confirm Merge";
                closeMergeModal();
            }
        }
        
        async function saveChanges(event) {
            event.preventDefault();
            const user = firebase.auth().currentUser;
            const docId = document.getElementById('editDocId').value;
            if (!user || !docId) return;
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const groupId = userDoc.data().groupId;
                const editorName = userDoc.data().fullName || user.email;

                const updatedData = {
                    bell: parseInt(document.getElementById('editBell').value, 10),
                    parcel: parseInt(document.getElementById('editParcel').value, 10),
                    weight: document.getElementById('editWeight').value,
                    date: document.getElementById('editDate').value,
                    size: document.getElementById('editSize').value,
                    percentage: document.getElementById('editPercentage').value,
                    color: document.getElementById('editColor').value,
                    lastEditedBy: editorName,
                    lastEditedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('groups').doc(groupId).collection('parcels').doc(docId).update(updatedData);
                showToastMessage("Parcel updated successfully!");
                closeEditModal();
            } catch (error) {
                console.error("Error saving changes: ", error);
                alert("Could not save changes. Error: " + error.message);
            }
        }
        function openEditModal(docId){
            const entry = allData.find(e => e.id === docId);
            if (!entry) return;
            document.getElementById('editDocId').value = docId;
            document.getElementById('editBell').value = entry.bell;
            document.getElementById('editParcel').value = entry.parcel;
            document.getElementById('editWeight').value = entry.weight;
            document.getElementById('editDate').value = entry.date;
            document.getElementById('editSize').value = entry.size;
            document.getElementById('editPercentage').value = entry.percentage;
            document.getElementById('editColor').value = entry.color;
            editModal.style.display = "flex";
        }
        function closeEditModal(){ editModal.style.display = "none"; }
        function openAuditModal(docId){
            const entry = allData.find(e => e.id === docId);
            if (!entry) return;
            const formatTimestamp = (timestamp) => {
                if (timestamp && typeof timestamp.toDate === 'function') { return timestamp.toDate().toLocaleString(); }
                return 'N/A';
            };
            document.getElementById('createdBy').textContent = entry.createdBy || 'N/A';
            document.getElementById('createdAt').textContent = formatTimestamp(entry.createdAt);
            document.getElementById('lastEditedBy').textContent = entry.lastEditedBy || 'N/A';
            document.getElementById('lastEditedAt').textContent = formatTimestamp(entry.lastEditedAt);
            auditModal.style.display = "flex";
        }
        function closeAuditModal(){ auditModal.style.display = "none"; }
        window.onclick = function(event){
            if (event.target == editModal) { closeEditModal(); }
            if (event.target == auditModal) { closeAuditModal(); }
            if (event.target == mergeModal) { closeMergeModal(); }
        }
        function showToastMessage(message){
            const toast = document.createElement('div');
            toast.textContent = message;
            Object.assign(toast.style, {
                position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                backgroundColor: '#2c3e50', color: 'white', padding: '12px 24px', borderRadius: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: '1000', fontFamily: 'Nunito, sans-serif',
                fontSize: '16px', opacity: '0', transition: 'opacity 0.3s ease-in-out'
            });
            document.body.appendChild(toast);
            setTimeout(() => toast.style.opacity = '1', 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        function highlightRow(checkbox){
            const row = checkbox.closest("tr");
            if (!row.classList.contains("departure-row")) { row.classList.toggle("selected-row", checkbox.checked); } 
            else { checkbox.checked = false; }
        }
        function selectAllRows(masterCheckbox){
            document.querySelectorAll(".row-check").forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = masterCheckbox.checked;
                    highlightRow(cb);
                }
            });
        }
        function deleteEntry(docId){
            if (!confirm("Are you sure you want to delete this parcel?")) return;
            if (!currentGroupId) return alert("Error: Group ID not found.");
            db.collection('groups').doc(currentGroupId).collection('parcels').doc(docId).delete()
              .then(() => showToastMessage("Parcel deleted successfully."))
              .catch(error => showToastMessage("Error deleting parcel."));
        }
        async function toggleDepartureStatus(docId){
            if (!currentGroupId || !docId) return alert("Error: Group ID not found.");
            try {
                const docRef = db.collection('groups').doc(currentGroupId).collection('parcels').doc(docId);
                const doc = await docRef.get();
                if (doc.exists) {
                    const newStatus = !doc.data().departure;
                    await docRef.update({ departure: newStatus });
                    const message = newStatus ? "Marked as departed." : "Marked as not departed.";
                    showToastMessage(message);
                }
            } catch (error) {
                console.error("Error updating departure status: ", error);
                showToastMessage("Error updating status.");
            }
        }
        document.getElementById("searchBox").addEventListener("input", applyFilters);
        document.getElementById("filterFrom").addEventListener("change", applyFilters);
        document.getElementById("filterTo").addEventListener("change", applyFilters);
    </script>
</body>
</html>